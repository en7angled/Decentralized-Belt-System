---
description: Projections, rollback, upsert, and backfill for chain-sync and Storage/Ingestion
globs: src/lib/offchain-lib/**/*.hs, src/exe/chain-sync/**/*
alwaysApply: false
---
# Storage, Ingestion & Chain-Sync

Context: See [project-architecture.mdc](../architecture/project-architecture.mdc) "Conceptual flows" for where this fits (onchain events → projections).

- **Onchain events → database projections**: Chain-sync receives validator-output matches (e.g. from Kupo/Atlas). Each match is transformed into a projection row: Ingestion.`projectChainEvent` maps address and datum to a `ChainEventProjection` (domain event: Rank, Profile, Promotion, MembershipHistory, MembershipInterval, Achievement), using Conversions to turn onchain datums into domain types; Storage.`putMatchAndProjections` persists the raw match and dispatches to `put*Projection` (e.g. `putRankProjection`, `putProfileProjection`) to upsert into projection tables. New projection type → extend this flow and update rollback.
- **Projections**: New concept → new event in `ChainEventProjection`, case in `projectChainEvent` (Ingestion), Persistent entity + `put*` in Storage, and **update `rollbackTo`** for the new table.
- **Idempotence**: Use `upsertByUnique` and a `Unique*` constraint for projection tables.
- **Backfill**: Use when a projection B depends on A and A can be processed after B. Document or implement backfill for that case. Example: when a membership history projection is stored, Storage backfills `organizationProfileId` on existing interval projections that have the same practitioner and NULL org and belong to that history (same ID derivation)—handling the case where the interval event was processed before the history event.
